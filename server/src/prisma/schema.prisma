// =====================================================
// Prisma Schema â€” Production-Grade Variant-First Ecommerce
// =====================================================

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =====================
// ENUMS
// =====================

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  RETURN_REQUESTED
  RETURNED
  REFUNDED
}

enum CartStatus {
  ACTIVE
  CHECKED_OUT
  ABANDONED
}

enum ShippingMethod {
  STANDARD
  EXPRESS
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  RECEIVED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PAYMENT
  REFUND
}

// =====================
// USER & AUTH
// =====================

model User {
  id       String  @id @default(uuid())
  userName String
  email    String  @unique
  password String?
  role     Role    @default(USER)

  orders              Order[]
  addresses           Address[]
  carts               Cart[]
  reviews             Review[]
  auditLogs           AuditLog[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  returnRequests ReturnRequest[]

  @@index([email])
}

model RefreshToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String
  revoked   Boolean  @default(false)
  expiresAt DateTime

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  tokenHash String
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
}

// =====================
// ADDRESS
// =====================

model Address {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName   String?
  phone      String
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String
  country    String

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
}

// =====================
// CATALOG
// =====================

model Category {
  id       String  @id @default(uuid())
  name     String
  slug     String  @unique
  parentId String?

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")

  products Product[]

  createdAt   DateTime   @default(now())
  promotion   Promotion? @relation(fields: [promotionId], references: [id])
  promotionId String?
}

model Product {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String   @db.Text
  tag         String[]
  brand       String?
  isActive    Boolean  @default(true)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  variants ProductVariant[]
  images   ProductImage[]
  reviews  Review[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  promotion   Promotion? @relation(fields: [promotionId], references: [id])
  promotionId String?

  @@index([categoryId])
  @@index([isActive])
}

model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku        String  @unique
  price      Decimal @db.Decimal(10, 2)
  attributes Json?

  inventory Inventory?

  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  promotion   Promotion? @relation(fields: [promotionId], references: [id])
  promotionId String?

  @@index([productId])
}

model Inventory {
  id        String         @id @default(uuid())
  variantId String         @unique
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  quantity Int
  reserved Int @default(0)

  updatedAt DateTime @updatedAt

  @@index([quantity])
}

model ProductImage {
  id        String  @id @default(uuid())
  productId String
  publicId  String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  url    String
  isMain Boolean @default(false)
}

model Promotion {
  id String @id @default(uuid())

  name        String
  description String?

  discountType  String // PERCENT | FIXED
  discountValue Decimal @db.Decimal(10, 2)

  startsAt DateTime
  endsAt   DateTime

  appliesTo   String // PRODUCT | VARIANT | CATEGORY | CART
  isStackable Boolean @default(false)

  isActive Boolean @default(true)

  products   Product[]
  variants   ProductVariant[]
  categories Category[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================
// CART
// =====================

model Cart {
  id String @id @default(uuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  sessionId String?    @unique
  status    CartStatus @default(ACTIVE)

  items CartItem[]

  // ===== PRICING BREAKDOWN =====
  subtotal Decimal @db.Decimal(10, 2) @default(0)

  // Coupon
  couponId       String?
  coupon         Coupon?  @relation(fields: [couponId], references: [id])
  discountPct    Int?
  discountAmount Decimal? @db.Decimal(10, 2)

  // Tax
  taxRate   Decimal? @db.Decimal(5, 2) @default(0)
  taxAmount Decimal? @db.Decimal(10, 2) @default(0)

  // Shipping
  shippingMethod String?
  shippingAmount Decimal? @db.Decimal(10, 2)

  // Final
  total Decimal @db.Decimal(10, 2) @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model CartItem {
  id String @id @default(uuid())

  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  quantity Int
  // Snapshots
  price       Decimal
  originalPrice Decimal?
  promotionId String?
  name  String
  sku   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, variantId])
  @@index([cartId])
}

model ShippingRate {
  id String @id @default(uuid())

  country String
  state   String?

  method ShippingMethod

  price Decimal @db.Decimal(10,2)

  minOrder Decimal? @db.Decimal(10,2)
  maxOrder Decimal? @db.Decimal(10,2)

  currency String @default("PKR")

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country, state, method])
}

// =====================
// ORDER & PAYMENT
// =====================

model Order {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  status OrderStatus @default(PENDING)

  // ===== SNAPSHOT PRICING =====
  subtotal Decimal @db.Decimal(10, 2)

  couponId       String?
  coupon         Coupon?  @relation(fields: [couponId], references: [id])
  discountPct    Int?
  discountAmount Decimal? @db.Decimal(10, 2)

  taxRate   Decimal
  taxAmount Decimal @db.Decimal(10, 2)

  shippingMethod String
  shippingAmount Decimal @db.Decimal(10, 2)

  total Decimal @db.Decimal(10, 2)

  shippingAddr Json
  billingAddr  Json

  items OrderItem[]

  payment Payment?
  refunds Refund[]
  returns ReturnRequest[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  variantId String

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id])

  price    Decimal
  quantity Int

  @@index([orderId])
}

model Payment {
  id      String @id @default(uuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  provider      String
  status        PaymentStatus
  transactionId String
  amount        Decimal

  refunds Refund[]

  createdAt DateTime @default(now())

  @@index([status])
  @@index([transactionId])
}

// =====================
// REVIEWS
// =====================

model Review {
  id        String @id @default(uuid())
  userId    String
  productId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  rating  Int
  comment String?

  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

// =====================
// COUPONS
// =====================

model Coupon {
  id   String @id @default(uuid())
  code String @unique

  discountType  String @default("PERCENT") // PERCENT | FIXED
  discountValue Int

  minCartTotal Decimal? @db.Decimal(10, 2)

  expiresAt  DateTime
  usageLimit Int?
  usedCount  Int      @default(0)

  isActive Boolean @default(true)

  carts  Cart[]
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================
// REFUNDS & RETURNS
// =====================

model Refund {
  id        String @id @default(uuid())
  orderId   String
  paymentId String

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  amount Decimal
  reason String?
  status RefundStatus

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([paymentId])
}

model ReturnRequest {
  id      String @id @default(uuid())
  orderId String
  userId  String

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  reason String
  status ReturnStatus @default(REQUESTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([userId])
}

// =====================
// AUDIT LOG
// =====================

model AuditLog {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action   AuditAction
  entity   String
  entityId String
  metadata Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([entity])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
}
