// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  RETURN_REQUESTED
  RETURNED
  REFUNDED
}

enum CartStatus {
  ACTIVE
  CHECKED_OUT
  ABANDONED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  RECEIVED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PAYMENT
  REFUND
}

model User {
  id       String  @id @default(uuid())
  userName String
  email    String  @unique
  password String?
  role     Role    @default(USER)

  orders    Order[]
  addresses Address[]
  cartItems CartItem[]
  reviews   Review[]

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  deletedAt           DateTime?
  returnRequests      ReturnRequest[]
  auditLogs           AuditLog[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]

  @@index([email])
}

model RefreshToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  tokenHash String
  revoked   Boolean  @default(false)
  expiresAt DateTime

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  tokenHash String
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
}

model Address {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  fullName   String
  phone      String
  line1      String
  line2      String?
  city       String
  state      String
  postalCode String
  country    String

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
}

model Category {
  id       String     @id @default(uuid())
  name     String
  slug     String     @unique
  parentId String?
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")

  products Product[]

  createdAt DateTime @default(now())
}

model Product {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String
  price       Decimal
  quantity    Int     @default(1)
  isActive    Boolean @default(true)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  variants ProductVariant[]
  images   ProductImage[]
  reviews  Review[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  inventory   Inventory?
  hasVariants Boolean    @default(false)
  cartItems   CartItem[]

  @@index([categoryId])
  @@index([isActive])
}

model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  sku        String  @unique
  price      Decimal
  attributes Json

  inventory Inventory?

  createdAt  DateTime    @default(now())
  deletedAt  DateTime?
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
}

model Inventory {
  id        String          @id @default(uuid())
  variantId String?         @unique
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  productId String?         @unique
  product   Product?        @relation(fields: [productId], references: [id])
  quantity  Int
  updatedAt DateTime        @updatedAt

  @@index([quantity])
}

model ProductImage {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  url    String
  isMain Boolean @default(false)
}

model Cart {
  id String @id @default(uuid())

  userId    String? @unique
  sessionId String? @unique // for guest carts

  status CartStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items CartItem[]

  @@index([userId])
  @@index([sessionId])
}

model CartItem {
  id String @id @default(uuid())

  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  variantId String?

  quantity Int @default(1)

  price Decimal
  name  String
  sku   String?

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User?           @relation(fields: [userId], references: [id])
  userId           String?
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])
  productVariantId String?

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  @@index([variantId])
}

model Order {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  status      OrderStatus @default(PENDING)
  totalAmount Decimal

  shippingAddr Json
  billingAddr  Json

  items   OrderItem[]
  payment Payment?
  refunds Refund[]
  returns ReturnRequest[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  variantId String

  order   Order          @relation(fields: [orderId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  price    Decimal
  quantity Int

  @@index([orderId])
  @@index([variantId])
}

model Payment {
  id      String @id @default(uuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  provider      String
  status        PaymentStatus
  transactionId String
  amount        Decimal

  refunds Refund[]

  createdAt DateTime @default(now())

  @@index([status])
  @@index([transactionId])
}

model Review {
  id        String @id @default(uuid())
  userId    String
  productId String

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  rating  Int
  comment String?

  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

model Coupon {
  id          String   @id @default(uuid())
  code        String   @unique
  discountPct Int
  expiresAt   DateTime
  usageLimit  Int?
  usedCount   Int      @default(0)
  isActive    Boolean  @default(true)
}

model Refund {
  id        String @id @default(uuid())
  orderId   String
  paymentId String

  order   Order   @relation(fields: [orderId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])

  amount Decimal
  reason String?
  status RefundStatus

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([paymentId])
  @@index([status])
}

model ReturnRequest {
  id      String @id @default(uuid())
  orderId String
  userId  String

  order Order @relation(fields: [orderId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  reason String
  status ReturnStatus @default(REQUESTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([userId])
  @@index([status])
}

model AuditLog {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action   AuditAction
  entity   String // "Order", "Product", "Refund"
  entityId String
  metadata Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([entity])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
}
